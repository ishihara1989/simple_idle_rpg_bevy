# Architecture Guide

This document describes the technical architecture and design principles of Simple Idle RPG.

## Overview

Simple Idle RPG is built using **Rust + Bevy ECS 0.16.1** with a strict ECS (Entity Component System) architecture. The game follows a plugin-based design for modularity and maintainability.

## Core Architecture

### ECS Design Principles

After recent refactoring, this codebase follows strict ECS principles:

- **Single Responsibility**: Each system handles one specific aspect (e.g., `hp_sync_system` only syncs HP)
- **Type Safety**: Marker components instead of string-based identification
- **Small Systems**: Target 20-30 lines per system, max 50 lines
- **Event-Driven**: Loose coupling between systems via Bevy events

### Technology Stack
- **ECS Framework**: Bevy ECS 0.16.1
- **Large Numbers**: `too_big_float` (BigFloat) - For handling exponential growth in idle games
- **CLI**: `clap` - Command line argument parsing for balance testing
- **Game Type**: Real-time combat idle RPG

### 1.2 ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ 
```
src/
â”œâ”€â”€ components/          # ECSã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå®šç¾©
â”‚   â”œâ”€â”€ combat_stats.rs    # æˆ¦é—˜ç”¨ã®ä¸€æ™‚çš„ãªã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
â”‚   â”œâ”€â”€ management_stats.rs # ç®¡ç†ç”¨ã®æ°¸ç¶šçš„ãªã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
â”‚   â”œâ”€â”€ upgradeable_stats.rs # ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰å¯èƒ½ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆæ–°é…ç½®ï¼‰
â”‚   â””â”€â”€ markers.rs         # ãƒãƒ¼ã‚«ãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
â”œâ”€â”€ systems/             # ECSã‚·ã‚¹ãƒ†ãƒ å®Ÿè£…
â”‚   â”œâ”€â”€ initialization.rs   # åˆæœŸåŒ–ã‚·ã‚¹ãƒ†ãƒ 
â”‚   â”œâ”€â”€ combat_core.rs     # æˆ¦é—˜ã‚³ã‚¢ã‚·ã‚¹ãƒ†ãƒ 
â”‚   â”œâ”€â”€ combat_end.rs      # æˆ¦é—˜çµ‚äº†ã‚·ã‚¹ãƒ†ãƒ 
â”‚   â””â”€â”€ upgrades.rs        # ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ãƒ»åŒæœŸã‚·ã‚¹ãƒ†ãƒ ï¼ˆæ–°é…ç½®ï¼‰
â”œâ”€â”€ events/              # ã‚¤ãƒ™ãƒ³ãƒˆå®šç¾©
â”‚   â””â”€â”€ combat_events.rs   # æˆ¦é—˜é–¢é€£ã‚¤ãƒ™ãƒ³ãƒˆ
â”œâ”€â”€ plugins/             # ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚·ã‚¹ãƒ†ãƒ  âœ… æ–°è¦è¿½åŠ  (2025-06-19)
â”‚   â”œâ”€â”€ combat.rs          # æˆ¦é—˜é–¢é€£ãƒ—ãƒ©ã‚°ã‚¤ãƒ³
â”‚   â”œâ”€â”€ stats.rs           # ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç®¡ç†ãƒ—ãƒ©ã‚°ã‚¤ãƒ³
â”‚   â”œâ”€â”€ ui.rs              # UIç®¡ç†ãƒ—ãƒ©ã‚°ã‚¤ãƒ³
â”‚   â””â”€â”€ player.rs          # ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ç®¡ç†ãƒ—ãƒ©ã‚°ã‚¤ãƒ³
â”œâ”€â”€ ui/                  # UIå°‚ç”¨ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
â”‚   â”œâ”€â”€ setup.rs           # UIåˆæœŸåŒ–
â”‚   â”œâ”€â”€ combat_ui.rs       # æˆ¦é—˜UIæ›´æ–°
â”‚   â””â”€â”€ tab_ui.rs          # ã‚¿ãƒ–ã‚·ã‚¹ãƒ†ãƒ 
â””â”€â”€ main.rs             # ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆãƒ—ãƒ©ã‚°ã‚¤ãƒ³ç™»éŒ²ã®ã¿ï¼‰
```

### 1.3 ECSã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè¨­è¨ˆ

#### æˆ¦é—˜ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆcombat_stats.rsï¼‰
- `CurrentHp`, `MaxHp` - HPç®¡ç†
- `CombatAttack`, `CombatDefense`, `CombatSpeed` - æˆ¦é—˜ç”¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
- `AttackCooldown` - ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æˆ¦é—˜ç”¨ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³
- `ExpReward`, `EnemyNumber` - æ•µå›ºæœ‰ãƒ‡ãƒ¼ã‚¿

#### ç®¡ç†ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆmanagement_stats.rsï¼‰
- `BaseAttack`, `BaseDefense`, `BaseSpeed`, `BaseHp` - åŸºæœ¬ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
- `Experience`, `Level`, `RebirthPoints` - é€²è¡Œç®¡ç†

#### ãƒãƒ¼ã‚«ãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼ˆmarkers.rsï¼‰
- `Player`, `Enemy` - ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£è­˜åˆ¥
- `StatsText`, `CombatText` - UIè¦ç´ è­˜åˆ¥
- `GameState` - ã‚²ãƒ¼ãƒ å…¨ä½“ã®çŠ¶æ…‹ç®¡ç†ï¼ˆResourceï¼‰

#### ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã‚·ã‚¹ãƒ†ãƒ ï¼ˆcomponents/upgradeable_stats.rsï¼‰
- `CurrentValue`, `BaseValue`, `UpgradeLevel` - ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å€¤ç®¡ç†ï¼ˆLevel â†’ UpgradeLevel ã«åå‰å¤‰æ›´ï¼‰
- `UpgradeCost`, `UpgradeMultiplier`, `CostMultiplier` - ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰è¨ˆç®—
- `UpgradeableStat` - ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰å¯èƒ½ãªçµ±è¨ˆã®è­˜åˆ¥
- å‹å®‰å…¨ãƒãƒ¼ã‚«ãƒ¼: `UpgradeableHp`, `UpgradeableAttack`, `UpgradeableDefense`, `UpgradeableSpeed`

### 1.4 ã‚·ã‚¹ãƒ†ãƒ ãƒ•ãƒ­ãƒ¼

#### åˆæœŸåŒ–ãƒ•ãƒ­ãƒ¼
1. `player_init_system` - ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã¨åŸºæœ¬ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ä½œæˆ
2. `combat_init_system` - æˆ¦é—˜ç”¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®åˆæœŸåŒ–ã¨æ•µã‚¹ãƒãƒ¼ãƒ³

#### ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æˆ¦é—˜ãƒ•ãƒ­ãƒ¼
1. `attack_cooldown_system` - ã‚¹ãƒ”ãƒ¼ãƒ‰ã«åŸºã¥ãã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³æ¸›å°‘
2. `real_time_attack_system` - æ”»æ’ƒå¯èƒ½ãªå ´åˆã®AttackEventç™ºç«
3. `damage_application_system` - ãƒ€ãƒ¡ãƒ¼ã‚¸é©ç”¨ã¨DeathEventç™ºç«

#### æˆ¦é—˜çµ‚äº†ãƒ•ãƒ­ãƒ¼
1. `death_detection_system` - æ­»äº¡æ¤œå‡ºã¨ã‚¤ãƒ™ãƒ³ãƒˆåˆ†å²
2. `enemy_death_system` / `player_death_system` - æ­»äº¡å‡¦ç†
3. `exp_gain_system` - çµŒé¨“å€¤ç²å¾—
4. `next_enemy_spawn_system` - æ¬¡ã®æ•µã‚¹ãƒãƒ¼ãƒ³

#### ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ãƒ•ãƒ­ãƒ¼ï¼ˆsystems/upgrades.rsï¼‰
1. `upgradeable_stat_upgrade_system` - çµŒé¨“å€¤ã§ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è‡ªå‹•ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰
2. å€‹åˆ¥åŒæœŸã‚·ã‚¹ãƒ†ãƒ  - ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰å¾Œã®æˆ¦é—˜ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åŒæœŸ
   - `hp_sync_system` - HPåŒæœŸå°‚ç”¨
   - `attack_sync_system` - æ”»æ’ƒåŠ›åŒæœŸå°‚ç”¨  
   - `defense_sync_system` - é˜²å¾¡åŠ›åŒæœŸå°‚ç”¨
   - `speed_sync_system` - ã‚¹ãƒ”ãƒ¼ãƒ‰åŒæœŸå°‚ç”¨

## 2. ECSè¨­è¨ˆé•åã¨ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°èª²é¡Œ

### 2.1 é•·ã„é–¢æ•°ï¼ˆECSåŸå‰‡é•åï¼‰

#### ~~ğŸ”´ é‡è¦åº¦: é«˜~~ âœ… **ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°å®Œäº†** (2025-06-19)
- ~~**`real_time_attack_system`**~~ âœ… **è§£æ±ºæ¸ˆã¿** (combat_core.rs:30-85, 55è¡Œ)
  - ~~ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨æ•µã®æ”»æ’ƒå‡¦ç†ã‚’ä¸€ã¤ã®é–¢æ•°ã§å‡¦ç†~~
  - ~~è²¬ä»»ã®åˆ†é›¢ãŒã§ãã¦ã„ãªã„~~
  - **è§£æ±ºæ¸ˆã¿**: `player_attack_system`ã¨`enemy_attack_system`ã«åˆ†é›¢å®Œäº†

- ~~**`sync_stats_system`**~~ âœ… **ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°å®Œäº†** (2025-06-19)
  - ~~è¤‡æ•°ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚¿ã‚¤ãƒ—ã‚’æ–‡å­—åˆ—æ¯”è¼ƒã§å‡¦ç†~~
  - ~~æ‹¡å¼µæ€§ãŒä½ãã€å‹å®‰å…¨æ€§ã«æ¬ ã‘ã‚‹~~
  - **è§£æ±ºæ¸ˆã¿**: å‹å®‰å…¨ãªå€‹åˆ¥åŒæœŸã‚·ã‚¹ãƒ†ãƒ ã«åˆ†é›¢å®Œäº†

#### ğŸŸ¡ é‡è¦åº¦: ä¸­
- **`player_death_system`** (combat_end.rs:60-89, 29è¡Œ)
  - æ­»äº¡å‡¦ç†ã€ãƒªãƒãƒ¼ã‚¹ã€ãƒªã‚¹ãƒãƒ¼ãƒ³ã‚’ä¸€ã¤ã®é–¢æ•°ã§å‡¦ç†

### 2.2 è¤‡æ•°ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆæ›¸ãè¾¼ã¿ï¼ˆECSåŸå‰‡é•åï¼‰

#### ğŸ”´ é‡è¦åº¦: é«˜
- ~~**`sync_stats_system`**~~ âœ… **ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°å®Œäº†** (2025-06-19)
  - ~~5ã¤ã®ç•°ãªã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«æ›¸ãè¾¼ã¿~~
  - ~~`CombatAttack`, `CombatDefense`, `CombatSpeed`, `MaxHp`, `CurrentHp`~~
  - ~~ECSã®å˜ä¸€è²¬ä»»åŸå‰‡ã«é•å~~
  - **è§£æ±ºæ¸ˆã¿**: å„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå°‚ç”¨ã®å€‹åˆ¥ã‚·ã‚¹ãƒ†ãƒ ã«åˆ†é›¢

- **`combat_init_system`** - è¤‡æ•°ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ä¸€åº¦ã«è¿½åŠ 
  - åˆæœŸåŒ–å‡¦ç†ã¨ã—ã¦ã¯å¦¥å½“ã ãŒã€åˆ†é›¢å¯èƒ½

#### ğŸŸ¡ é‡è¦åº¦: ä¸­
- **`rebirth_player_system`** - è¤‡æ•°ã®ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã¨å¤šæ§˜ãªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ä½œæˆ

### 2.3 è¨­è¨ˆä¸Šã®èª²é¡Œ

#### ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ãƒ¬ãƒ™ãƒ«
- ~~**UIå‡¦ç†ã®æ··åœ¨**: main.rsã«200è¡Œä»¥ä¸Šã®UIå‡¦ç†ãŒæ··åœ¨~~ âœ… **è§£æ±ºæ¸ˆã¿** (UIPluginåˆ†é›¢å®Œäº†)
- ~~**æ–‡å­—åˆ—ãƒ™ãƒ¼ã‚¹å‡¦ç†**: `sync_stats_system`ã§ã®statåã®æ–‡å­—åˆ—æ¯”è¼ƒ~~ âœ… **è§£æ±ºæ¸ˆã¿**
- ~~**å¤§è¦æ¨¡ãªåˆæœŸåŒ–**: main.rsã®è¤‡é›‘ãªåˆæœŸåŒ–å‡¦ç†~~ âœ… **è§£æ±ºæ¸ˆã¿** (ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚·ã‚¹ãƒ†ãƒ å°å…¥)

#### ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè¨­è¨ˆ
- ~~**é‡è¤‡ã™ã‚‹Level**: `management_stats::Level`ã¨`upgradeable_stat::Level`~~ âœ… **è§£æ±ºæ¸ˆã¿** (UpgradeLevel ã«å¤‰æ›´)
- ~~**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åŒæœŸã®è¤‡é›‘æ€§**: BaseStats â†” CombatStatsé–“ã®åŒæœŸ~~ âœ… **è§£æ±ºæ¸ˆã¿**
- **å‘½åã®ä¸€è²«æ€§**: ä¸€éƒ¨ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆåãŒä¸æ˜ç¢º

## 3. ä»Šå¾Œã®ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°èª²é¡Œ

### 3.1 ã‚·ã‚¹ãƒ†ãƒ åˆ†é›¢ã€å„ªå…ˆåº¦: é«˜ã€‘

#### ~~æˆ¦é—˜ã‚·ã‚¹ãƒ†ãƒ ã®åˆ†é›¢~~ âœ… **å®Œäº†** (2025-06-19)
```rust
// âœ… å®Ÿè£…å®Œäº†: ECSæº–æ‹ ã®åˆ†é›¢ã‚·ã‚¹ãƒ†ãƒ 
player_attack_system()      // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ”»æ’ƒå°‚ç”¨ (~18è¡Œ)
enemy_attack_system()       // æ•µæ”»æ’ƒå°‚ç”¨ (~18è¡Œ)
execute_attack_if_ready()   // å…±æœ‰æ”»æ’ƒãƒ­ã‚¸ãƒƒã‚¯ (~15è¡Œ)
```

#### ~~ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åŒæœŸã‚·ã‚¹ãƒ†ãƒ ã®åˆ†é›¢~~ âœ… **å®Œäº†** (2025-06-19)
```rust
// âœ… å®Ÿè£…å®Œäº†: å‹å®‰å…¨ãªå€‹åˆ¥åŒæœŸã‚·ã‚¹ãƒ†ãƒ 
hp_sync_system()      // HPåŒæœŸå°‚ç”¨ (~15è¡Œ)
attack_sync_system()  // æ”»æ’ƒåŠ›åŒæœŸå°‚ç”¨ (~10è¡Œ)
defense_sync_system() // é˜²å¾¡åŠ›åŒæœŸå°‚ç”¨ (~10è¡Œ)
speed_sync_system()   // ã‚¹ãƒ”ãƒ¼ãƒ‰åŒæœŸå°‚ç”¨ (~10è¡Œ)
```

### 3.2 ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå†è¨­è¨ˆã€å„ªå…ˆåº¦: é«˜ã€‘

#### ~~ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åŒæœŸã®å‹å®‰å…¨æ€§å‘ä¸Š~~ âœ… **å®Œäº†** (2025-06-19)
```rust
// âœ… å®Ÿè£…å®Œäº†: å‹å®‰å…¨ãªãƒãƒ¼ã‚«ãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
#[derive(Component)]
pub struct UpgradeableHp;      // HPç”¨ãƒãƒ¼ã‚«ãƒ¼

#[derive(Component)]
pub struct UpgradeableAttack;  // æ”»æ’ƒåŠ›ç”¨ãƒãƒ¼ã‚«ãƒ¼

#[derive(Component)]
pub struct UpgradeableDefense; // é˜²å¾¡åŠ›ç”¨ãƒãƒ¼ã‚«ãƒ¼

#[derive(Component)]
pub struct UpgradeableSpeed;   // ã‚¹ãƒ”ãƒ¼ãƒ‰ç”¨ãƒãƒ¼ã‚«ãƒ¼

// å‹å®‰å…¨ãªã‚¯ã‚¨ãƒªä¾‹:
Query<&CurrentValue, (With<UpgradeableHp>, Changed<CurrentValue>)>
```

#### ~~Level ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®çµ±ä¸€~~ âœ… **å®Œäº†** (2025-06-19)
```rust
// âœ… é‡è¤‡è§£æ¶ˆå®Œäº†
// Before: upgradeable_stat::Level ã¨ management_stats::Level ã®é‡è¤‡
// After: upgradeable_stats::UpgradeLevel ã«å¤‰æ›´ã€é‡è¤‡è§£æ¶ˆ
```

### ~~3.3 UIã‚·ã‚¹ãƒ†ãƒ åˆ†é›¢ã€å„ªå…ˆåº¦: ä¸­ã€‘~~ âœ… **å®Œäº†** (2025-06-19)

#### ~~UIå°‚ç”¨ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ä½œæˆ~~ âœ… **å®Ÿè£…å®Œäº†**
```rust
// âœ… å®Ÿè£…æ¸ˆã¿: UIå°‚ç”¨ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚·ã‚¹ãƒ†ãƒ 
src/plugins/ui.rs        // UIãƒ—ãƒ©ã‚°ã‚¤ãƒ³ (setup_ui, update_ui_system, tab_button_system)
src/ui/                  // UIå°‚ç”¨ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
â”œâ”€â”€ mod.rs
â”œâ”€â”€ setup.rs             // UIåˆæœŸåŒ–
â”œâ”€â”€ combat_ui.rs         // æˆ¦é—˜UIæ›´æ–°
â””â”€â”€ tab_ui.rs            // ã‚¿ãƒ–ã‚·ã‚¹ãƒ†ãƒ 
```

### 3.4 ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å¼·åŒ–ã€å„ªå…ˆåº¦: ä¸­ã€‘

#### ã‚ˆã‚Šç´°ã‹ã„ã‚¤ãƒ™ãƒ³ãƒˆåˆ†å‰²
```rust
// æ”»æ’ƒé–¢é€£
PlayerAttackEvent, EnemyAttackEvent // æ”»æ’ƒè€…åˆ¥ã‚¤ãƒ™ãƒ³ãƒˆ
DamageCalculatedEvent               // ãƒ€ãƒ¡ãƒ¼ã‚¸è¨ˆç®—çµæœ
CriticalHitEvent                   // ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«å°‚ç”¨

// ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é–¢é€£  
StatUpgradeEvent<T>                // ã‚¸ã‚§ãƒãƒªãƒƒã‚¯å‹ã§ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç‰¹å®š
StatSyncRequestEvent               // åŒæœŸè¦æ±‚ã‚¤ãƒ™ãƒ³ãƒˆ
```

## 4. ECSè¨­è¨ˆã®åŸºæœ¬åŸå‰‡ã¨æŒ‡é‡

### 4.1 ECSã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®æ ¸å¿ƒæ¦‚å¿µ

#### Single Responsibility Principle (å˜ä¸€è²¬ä»»åŸå‰‡)
- **1ã‚·ã‚¹ãƒ†ãƒ  = 1ã¤ã®æ˜ç¢ºãªè²¬ä»»**
- ã‚·ã‚¹ãƒ†ãƒ ã¯ç‰¹å®šã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®çµ„ã¿åˆã‚ã›ã®ã¿ã‚’å‡¦ç†
- è¤‡æ•°ã®ç•°ãªã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚¿ã‚¤ãƒ—ã¸ã®æ›¸ãè¾¼ã¿ã¯é¿ã‘ã‚‹

#### Data-Driven Design (ãƒ‡ãƒ¼ã‚¿é§†å‹•è¨­è¨ˆ)
- **ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ = ç´”ç²‹ãªãƒ‡ãƒ¼ã‚¿**
- ãƒ­ã‚¸ãƒƒã‚¯ã¯ã‚·ã‚¹ãƒ†ãƒ ã«ã€ãƒ‡ãƒ¼ã‚¿ã¯ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«åˆ†é›¢
- ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆé–“ã®ä¾å­˜é–¢ä¿‚ã‚’æœ€å°åŒ–

#### Loose Coupling (ç–çµåˆ)
- **ã‚¤ãƒ™ãƒ³ãƒˆã‚·ã‚¹ãƒ†ãƒ æ´»ç”¨**
- ã‚·ã‚¹ãƒ†ãƒ é–“ã®ç›´æ¥çš„ãªä¾å­˜ã‚’é¿ã‘ã‚‹
- çŠ¶æ…‹å¤‰æ›´ã¯å°‚ç”¨ã‚¤ãƒ™ãƒ³ãƒˆã‚’é€šã˜ã¦é€šçŸ¥

### 4.2 ã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

#### ã‚·ã‚¹ãƒ†ãƒ ã‚µã‚¤ã‚ºã®ç›®å®‰
- **ç†æƒ³çš„ãªè¡Œæ•°**: 20-30è¡Œä»¥å†…
- **æœ€å¤§è¨±å®¹**: 50è¡Œï¼ˆè¤‡é›‘ãªè¨ˆç®—ãŒã‚ã‚‹å ´åˆï¼‰
- **50è¡Œè¶…éæ™‚**: è¤‡æ•°ã‚·ã‚¹ãƒ†ãƒ ã¸ã®åˆ†å‰²ã‚’æ¤œè¨

#### ã‚¯ã‚¨ãƒªè¨­è¨ˆã®åŸå‰‡
```rust
// âœ… Good: å˜ä¸€ã®è²¬ä»»ã€æ˜ç¢ºãªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆçµ„ã¿åˆã‚ã›
fn hp_regen_system(
    mut query: Query<&mut CurrentHp, With<RegenComponent>>,
) {}

// âŒ Bad: è¤‡æ•°ã®è²¬ä»»ã€å¤šæ§˜ãªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
fn update_all_combat_stats(
    mut query: Query<(&mut CurrentHp, &mut CombatAttack, &mut CombatDefense)>,
) {}
```

#### ã‚¤ãƒ™ãƒ³ãƒˆè¨­è¨ˆã®åŸå‰‡
```rust
// âœ… Good: ç‰¹å®šã®çŠ¶æ³ã‚’è¡¨ç¾
#[derive(Event)]
struct PlayerLevelUpEvent { new_level: u32 }

// âŒ Bad: æ±ç”¨çš„ã™ãã‚‹
#[derive(Event)]  
struct UpdateEvent { entity: Entity, data: String }
```

### 4.3 ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è€ƒæ…®äº‹é …

#### ã‚¯ã‚¨ãƒªã®æœ€é©åŒ–
- **Changed<T>ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼**: å¤‰æ›´ã•ã‚ŒãŸã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ã¿å‡¦ç†
- **With/Without**: ä¸è¦ãªã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®é™¤å¤–
- **ParallelIterator**: å¯èƒ½ãªå ´åˆã¯ä¸¦åˆ—å‡¦ç†

#### ã‚·ã‚¹ãƒ†ãƒ é †åºã®æœ€é©åŒ–
- **ä¾å­˜é–¢ä¿‚ã®æ˜ç¢ºåŒ–**: `.after()`, `.before()`ã®æ´»ç”¨
- **SystemSet**: é–¢é€£ã‚·ã‚¹ãƒ†ãƒ ã®ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
- **æ¡ä»¶ä»˜ãå®Ÿè¡Œ**: `run_if()`ã«ã‚ˆã‚‹ä¸è¦ãªå®Ÿè¡Œã®å›é¿

### 4.4 ãƒ†ã‚¹ãƒˆã¨ãƒ‡ãƒãƒƒã‚°

#### ã‚·ã‚¹ãƒ†ãƒ ã®ãƒ†ã‚¹ã‚¿ãƒ“ãƒªãƒ†ã‚£
```rust
// âœ… Good: ãƒ†ã‚¹ãƒˆã—ã‚„ã™ã„å°ã•ãªã‚·ã‚¹ãƒ†ãƒ 
#[cfg(test)]
mod tests {
    #[test]
    fn test_hp_regen() {
        // å˜ä¸€æ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆãŒç°¡å˜
    }
}
```

#### ãƒ‡ãƒãƒƒã‚°ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªè¨­è¨ˆ
- **æ˜ç¢ºãªå‘½å**: ã‚·ã‚¹ãƒ†ãƒ ãƒ»ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆåã‹ã‚‰æ©Ÿèƒ½ãŒç†è§£ã§ãã‚‹
- **é©åˆ‡ãªãƒ­ã‚°**: é‡è¦ãªçŠ¶æ…‹å¤‰æ›´ã‚’ãƒ­ã‚°å‡ºåŠ›
- **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**: `unwrap()`ã®ä½¿ç”¨ã‚’é¿ã‘ã€é©åˆ‡ãªã‚¨ãƒ©ãƒ¼å‡¦ç†

## 5. å®Œäº†ã—ãŸãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°

### 5.0 ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚·ã‚¹ãƒ†ãƒ å°å…¥ (2025-06-19)

#### ğŸ¯ **è§£æ±ºã—ãŸå•é¡Œ**
- **main.rsã®å·¨å¤§åŒ–**: 55è¡Œã®åˆæœŸåŒ–å‡¦ç† â†’ 13è¡Œã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ç™»éŒ²ã®ã¿
- **é–¢å¿ƒã®åˆ†é›¢**: è¤‡æ•°è²¬ä»»ã®æ··åœ¨ â†’ 4ã¤ã®å°‚ç”¨ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã«åˆ†é›¢
- **ä¿å®ˆæ€§ã®å‘ä¸Š**: ã‚·ã‚¹ãƒ†ãƒ è¿½åŠ æ™‚ã®å½±éŸ¿ç¯„å›²ã‚’æœ€å°åŒ–
- **å¯èª­æ€§ã®å‘ä¸Š**: å„ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãŒå˜ä¸€ã®é–¢å¿ƒäº‹ã«é›†ä¸­

#### ğŸ—ï¸ **å®Ÿè£…ã—ãŸã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£**

**ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚·ã‚¹ãƒ†ãƒ æ§‹é€ **:
```rust
// src/plugins/mod.rs - ãƒ—ãƒ©ã‚°ã‚¤ãƒ³çµ±åˆç®¡ç†
pub use combat::CombatPlugin;     // æˆ¦é—˜ã‚·ã‚¹ãƒ†ãƒ çµ±åˆ
pub use stats::StatsPlugin;       // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç®¡ç†çµ±åˆ
pub use ui::UIPlugin;             // UIç®¡ç†çµ±åˆ  
pub use player::PlayerPlugin;     // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ç®¡ç†çµ±åˆ
```

**å„ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®è²¬ä»»åˆ†é›¢**:
```rust
// PlayerPlugin: ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆæœŸåŒ–
.insert_resource(GameState { ... })
.add_systems(Startup, player_init_system)

// CombatPlugin: æˆ¦é—˜ã‚¤ãƒ™ãƒ³ãƒˆã¨æˆ¦é—˜ã‚·ã‚¹ãƒ†ãƒ 
.add_event::<AttackEvent>() + 6ã¤ã®æˆ¦é—˜ã‚¤ãƒ™ãƒ³ãƒˆ
.add_systems(Update, (combat_init_system, attack_systems, death_systems, ...))

// StatsPlugin: ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ãƒ»åŒæœŸã‚·ã‚¹ãƒ†ãƒ   
.add_systems(Update, (upgradeable_stat_upgrade_system, hp_sync_system, ...))

// UIPlugin: UIåˆæœŸåŒ–ãƒ»æ›´æ–°ã‚·ã‚¹ãƒ†ãƒ 
.add_systems(Startup, setup_ui)
.add_systems(Update, (update_ui_system, tab_button_system))
```

**ç°¡æ½”ã«ãªã£ãŸmain.rs**:
```rust
// Before: 55è¡Œã®è¤‡é›‘ãªåˆæœŸåŒ–
fn main() {
    App::new()
        .add_plugins(DefaultPlugins)
        .insert_resource(GameState { ... })
        .add_event::<AttackEvent>()
        // ... 50è¡Œä»¥ä¸Šã®åˆæœŸåŒ–å‡¦ç†
        .run();
}

// After: 13è¡Œã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ç™»éŒ²ã®ã¿
fn main() {
    App::new()
        .add_plugins(DefaultPlugins)
        .add_plugins((
            PlayerPlugin,
            CombatPlugin,
            StatsPlugin,
            UIPlugin,
        ))
        .run();
}
```

#### âœ… **çµæœã¨æ¤œè¨¼**
- **ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æˆåŠŸ**: ãƒ‡ãƒãƒƒã‚°ãƒ»ãƒªãƒªãƒ¼ã‚¹ãƒ“ãƒ«ãƒ‰å…±ã«æˆåŠŸ
- **æ©Ÿèƒ½ãƒªã‚°ãƒ¬ãƒƒã‚·ãƒ§ãƒ³ãªã—**: å…¨ã‚·ã‚¹ãƒ†ãƒ ãŒæ­£å¸¸å‹•ä½œ
- **é–¢å¿ƒã®åˆ†é›¢**: å„ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãŒæ˜ç¢ºãªè²¬ä»»ã‚’æŒã¤
- **æ‹¡å¼µæ€§å‘ä¸Š**: æ–°æ©Ÿèƒ½ã¯ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã¨ã—ã¦ç‹¬ç«‹è¿½åŠ å¯èƒ½

#### ğŸ”§ **æŠ€è¡“çš„è©³ç´°**
- **Before**: main.rs 55è¡Œï¼ˆã‚¤ãƒ™ãƒ³ãƒˆ7å€‹ + ã‚·ã‚¹ãƒ†ãƒ 15å€‹ + ãƒªã‚½ãƒ¼ã‚¹1å€‹ï¼‰
- **After**: main.rs 13è¡Œ + 4ã¤ã®å°‚ç”¨ãƒ—ãƒ©ã‚°ã‚¤ãƒ³
- **ä¿å®ˆæ€§**: æ–°ã‚·ã‚¹ãƒ†ãƒ è¿½åŠ æ™‚ã¯è©²å½“ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ã¿ç·¨é›†
- **ãƒ†ã‚¹ã‚¿ãƒ“ãƒªãƒ†ã‚£**: å„ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ç‹¬ç«‹ã—ã¦ãƒ†ã‚¹ãƒˆå¯èƒ½

### 5.1 real_time_attack_system ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚° (2025-06-19)

#### ğŸ¯ **è§£æ±ºã—ãŸå•é¡Œ**
- **ECSåŸå‰‡é•åã®è§£æ¶ˆ**: 55è¡Œã®å·¨å¤§ã‚·ã‚¹ãƒ†ãƒ  â†’ 2ã¤ã®å°‚ç”¨ã‚·ã‚¹ãƒ†ãƒ (å„18è¡Œ) + å…±æœ‰ãƒ˜ãƒ«ãƒ‘ãƒ¼(15è¡Œ)
- **å˜ä¸€è²¬ä»»åŸå‰‡ã®å®Ÿç¾**: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ»æ•µæ”»æ’ƒå‡¦ç†ã®æ··åœ¨ â†’ è²¬ä»»åˆ†é›¢å®Œäº†
- **ã‚³ãƒ¼ãƒ‰é‡è¤‡ã®æ’é™¤**: é‡è¤‡ãƒ­ã‚¸ãƒƒã‚¯ â†’ å…±æœ‰ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã§çµ±ä¸€
- **æ‹¡å¼µæ€§ã®å‘ä¸Š**: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼/æ•µå›ºæœ‰æ©Ÿèƒ½ã®è¿½åŠ ãŒå®¹æ˜“

#### ğŸ—ï¸ **å®Ÿè£…ã—ãŸã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£**

**åˆ†é›¢ã‚·ã‚¹ãƒ†ãƒ æ§‹é€ **:
```rust
player_attack_system()      // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ”»æ’ƒå°‚ç”¨ (~18è¡Œ)
enemy_attack_system()       // æ•µæ”»æ’ƒå°‚ç”¨ (~18è¡Œ) 
execute_attack_if_ready()   // å…±é€šæ”»æ’ƒãƒ­ã‚¸ãƒƒã‚¯ (~15è¡Œ)
```

**ECSæº–æ‹ ã®è¨­è¨ˆ**:
```rust
// Before: 1ã¤ã®å·¨å¤§ã‚·ã‚¹ãƒ†ãƒ 
pub fn real_time_attack_system(...) { /* 55è¡Œ */ }

// After: è²¬ä»»åˆ†é›¢ + å…±æœ‰ãƒ˜ãƒ«ãƒ‘ãƒ¼
pub fn player_attack_system(...) { /* 18è¡Œ */ }
pub fn enemy_attack_system(...) { /* 18è¡Œ */ }
fn execute_attack_if_ready(...) { /* 15è¡Œ */ }
```

**ã‚·ã‚¹ãƒ†ãƒ ç™»éŒ²ã®æ›´æ–°**:
```rust
// main.rs:32
// Before: real_time_attack_system,
// After: (player_attack_system, enemy_attack_system),
```

#### âœ… **çµæœã¨æ¤œè¨¼**
- **ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æˆåŠŸ**: ãƒ‡ãƒãƒƒã‚°ãƒ»ãƒªãƒªãƒ¼ã‚¹ãƒ“ãƒ«ãƒ‰å…±ã«æˆåŠŸ
- **å…¨ãƒ†ã‚¹ãƒˆé€šé**: 30å€‹ã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã™ã¹ã¦æˆåŠŸ
- **æ©Ÿèƒ½ãƒªã‚°ãƒ¬ãƒƒã‚·ãƒ§ãƒ³ãªã—**: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ»æ•µæ”»æ’ƒã‚·ã‚¹ãƒ†ãƒ ãŒæ­£å¸¸å‹•ä½œ
- **ECSæº–æ‹ **: å„ã‚·ã‚¹ãƒ†ãƒ ãŒå˜ä¸€è²¬ä»»ã‚’æŒã¡ã€é©åˆ‡ã«åˆ†é›¢

#### ğŸ”§ **æŠ€è¡“çš„è©³ç´°**
- **Before**: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ”»æ’ƒ(43-62è¡Œ) + æ•µæ”»æ’ƒ(64-84è¡Œ) = 55è¡Œã‚·ã‚¹ãƒ†ãƒ 
- **After**: 18è¡ŒÃ—2ã‚·ã‚¹ãƒ†ãƒ  + 15è¡Œå…±æœ‰ãƒ˜ãƒ«ãƒ‘ãƒ¼ = è²¬ä»»åˆ†é›¢å®Œäº†
- **é‡è¤‡æ’é™¤**: æ”»æ’ƒãƒ­ã‚¸ãƒƒã‚¯ã‚’`execute_attack_if_ready()`ã§çµ±ä¸€
- **æ‹¡å¼µæ€§**: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼/æ•µå›ºæœ‰ã®ãƒ­ã‚¸ãƒƒã‚¯è¿½åŠ ãŒå®¹æ˜“

### 5.2 sync_stats_system ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚° (2025-06-19)

#### ğŸ¯ **è§£æ±ºã—ãŸå•é¡Œ**
- **ECSåŸå‰‡é•åã®è§£æ¶ˆ**: 40è¡Œã®å·¨å¤§ã‚·ã‚¹ãƒ†ãƒ  â†’ 4ã¤ã®å°‚ç”¨ã‚·ã‚¹ãƒ†ãƒ (å„10-15è¡Œ)
- **å‹å®‰å…¨æ€§ã®å‘ä¸Š**: æ–‡å­—åˆ—ãƒ™ãƒ¼ã‚¹ã®åˆ¤å®š â†’ ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚å‹ãƒã‚§ãƒƒã‚¯
- **å˜ä¸€è²¬ä»»åŸå‰‡ã®å®Ÿç¾**: 5ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆåŒæ™‚å¤‰æ›´ â†’ å„ã‚·ã‚¹ãƒ†ãƒ 1ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
- **ä¿å®ˆæ€§ã®å‘ä¸Š**: æ–°ã—ã„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¿½åŠ æ™‚ã®å½±éŸ¿ç¯„å›²ã‚’æœ€å°åŒ–

#### ğŸ—ï¸ **å®Ÿè£…ã—ãŸã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£**

**å‹å®‰å…¨ãªãƒãƒ¼ã‚«ãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ**:
```rust
#[derive(Component)] pub struct UpgradeableHp;
#[derive(Component)] pub struct UpgradeableAttack;
#[derive(Component)] pub struct UpgradeableDefense;  
#[derive(Component)] pub struct UpgradeableSpeed;
```

**å€‹åˆ¥åŒæœŸã‚·ã‚¹ãƒ†ãƒ **:
```rust
pub fn hp_sync_system(...)      // MaxHp, CurrentHp ã®åŒæœŸ
pub fn attack_sync_system(...)  // CombatAttack ã®åŒæœŸ
pub fn defense_sync_system(...) // CombatDefense ã®åŒæœŸ
pub fn speed_sync_system(...)   // CombatSpeed ã®åŒæœŸ
```

**å‹å®‰å…¨ãªBundle**:
```rust
UpgradeableHpBundle::new(base_value, cost, multiplier, cost_multiplier)
UpgradeableAttackBundle::new(base_value, cost, multiplier, cost_multiplier)
// ... ä»–ã‚‚åŒæ§˜
```

#### âœ… **çµæœã¨æ¤œè¨¼**
- **ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æˆåŠŸ**: ãƒ‡ãƒãƒƒã‚°ãƒ»ãƒªãƒªãƒ¼ã‚¹ãƒ“ãƒ«ãƒ‰å…±ã«æˆåŠŸ
- **æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ**: æˆ¦é—˜ã‚·ã‚¹ãƒ†ãƒ ã€çµŒé¨“å€¤ç²å¾—ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åŒæœŸãŒæ­£å¸¸å‹•ä½œ
- **ECSæº–æ‹ **: å„ã‚·ã‚¹ãƒ†ãƒ ãŒå˜ä¸€è²¬ä»»ã‚’æŒã¡ã€é©åˆ‡ã«åˆ†é›¢
- **å‹å®‰å…¨**: ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã‚¨ãƒ©ãƒ¼ã®å¯èƒ½æ€§ã‚’æ’é™¤

#### ğŸ”§ **æŠ€è¡“çš„è©³ç´°**
- **Before**: `match stat.name.as_str() { "HP" => ... }`
- **After**: `Query<&CurrentValue, (With<UpgradeableHp>, Changed<CurrentValue>)>`
- **ã‚·ã‚¹ãƒ†ãƒ è¡Œæ•°**: 40è¡Œ â†’ 10-15è¡Œ x 4ã‚·ã‚¹ãƒ†ãƒ 
- **å‹å®‰å…¨æ€§**: ãƒ©ãƒ³ã‚¿ã‚¤ãƒ æ–‡å­—åˆ—æ¯”è¼ƒ â†’ ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚å‹ãƒã‚§ãƒƒã‚¯

## 6. ã¾ã¨ã‚

### ç¾åœ¨ã®è¨­è¨ˆã®è‰¯ã„ç‚¹
- **ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•**: æˆ¦é—˜ã‚·ã‚¹ãƒ†ãƒ ã§ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ´»ç”¨ã—ãŸç–çµåˆ
- **ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆåˆ†é›¢**: æˆ¦é—˜ç”¨ãƒ»ç®¡ç†ç”¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®é©åˆ‡ãªåˆ†é›¢
- **æ‹¡å¼µå¯èƒ½æ€§**: UpgradeableStatã‚·ã‚¹ãƒ†ãƒ ã®æ±ç”¨è¨­è¨ˆ

### æ”¹å–„ãŒå¿…è¦ãªç‚¹
- ~~**ã‚·ã‚¹ãƒ†ãƒ ã®å·¨å¤§åŒ–**: è¤‡æ•°è²¬ä»»ã‚’æŒã¤ã‚·ã‚¹ãƒ†ãƒ ã®åˆ†å‰²~~ âœ… **å®Œäº†** (sync_stats_system + real_time_attack_system)
- ~~**å‹å®‰å…¨æ€§**: æ–‡å­—åˆ—ãƒ™ãƒ¼ã‚¹å‡¦ç†ã®å‹å®‰å…¨ãªå®Ÿè£…ã¸ã®ç§»è¡Œ~~ âœ… **å®Œäº†**
- ~~**UIåˆ†é›¢**: ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ã‹ã‚‰ã®UIå‡¦ç†åˆ†é›¢~~ âœ… **å®Œäº†** (UIPluginåˆ†é›¢)
- ~~**main.rsã®å·¨å¤§åŒ–**: åˆæœŸåŒ–å‡¦ç†ã®åˆ†é›¢~~ âœ… **å®Œäº†** (ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚·ã‚¹ãƒ†ãƒ å°å…¥)

### æ¬¡æœŸé–‹ç™ºã§ã®é‡ç‚¹äº‹é …
1. ~~**ã‚·ã‚¹ãƒ†ãƒ åˆ†å‰²**: 50è¡Œè¶…ãˆã‚·ã‚¹ãƒ†ãƒ ã®ç´°åˆ†åŒ–~~ âœ… **å®Œäº†** (sync_stats_system + real_time_attack_system)
2. ~~**å‹å®‰å…¨æ€§å‘ä¸Š**: ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ã®å‹ãƒã‚§ãƒƒã‚¯å¼·åŒ–~~ âœ… **sync_stats_systemå®Œäº†**
3. ~~**ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚·ã‚¹ãƒ†ãƒ å°å…¥**: é–¢å¿ƒã®åˆ†é›¢ã¨main.rsç°¡ç•¥åŒ–~~ âœ… **å®Œäº†** (4ã¤ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã«åˆ†é›¢)
4. **ãƒ†ã‚¹ãƒˆæ•´å‚™**: å€‹åˆ¥ã‚·ã‚¹ãƒ†ãƒ ã®å˜ä½“ãƒ†ã‚¹ãƒˆä½œæˆ
5. **ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•´å‚™**: ã‚·ã‚¹ãƒ†ãƒ é–“ã®ä¾å­˜é–¢ä¿‚ã®æ–‡æ›¸åŒ–

### æ®‹ã‚Šã®é‡è¦ã‚¿ã‚¹ã‚¯
1. ~~**real_time_attack_system åˆ†å‰²**~~ âœ… **å®Œäº†** (55è¡Œ â†’ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼/æ•µæ”»æ’ƒã‚·ã‚¹ãƒ†ãƒ åˆ†é›¢)
2. ~~**UIåˆ†é›¢**~~ âœ… **å®Œäº†** (UIPlugin + UIå°‚ç”¨ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åˆ†é›¢)
3. ~~**ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚·ã‚¹ãƒ†ãƒ å°å…¥**~~ âœ… **å®Œäº†** (main.rs 55è¡Œ â†’ 13è¡Œã«å‰Šæ¸›)
4. ~~**ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã‚·ã‚¹ãƒ†ãƒ åˆ†é›¢**~~ âœ… **å®Œäº†** (2025-06-19) (components/systemsåˆ†é›¢)
5. ~~**Level ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆçµ±ä¸€**~~ âœ… **å®Œäº†** (UpgradeLevel ã«å¤‰æ›´ã€é‡è¤‡è§£æ¶ˆ)
6. ~~**ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•æˆ¦é—˜é–‹å§‹ã‚·ã‚¹ãƒ†ãƒ **~~ âœ… **å®Œäº†** (2025-06-20) (CombatStartEventå°å…¥)
7. **ãƒ†ã‚¹ãƒˆæ‹¡å……** (ç‰¹ã«æ–°ã—ãåˆ†é›¢ã—ãŸã‚·ã‚¹ãƒ†ãƒ ã®å˜ä½“ãƒ†ã‚¹ãƒˆ)

## 7. ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã‚·ã‚¹ãƒ†ãƒ åˆ†é›¢ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚° (2025-06-19)

### 7.1 è§£æ±ºã—ãŸå•é¡Œ
- **ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ä¸æ•´åˆã®è§£æ¶ˆ**: `src/upgradeable_stat.rs` ãŒæ ¹ãƒ¬ãƒ™ãƒ«ã«é…ç½®ã•ã‚Œã€ä»–ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãƒ»ã‚·ã‚¹ãƒ†ãƒ ã¨æ§‹æˆãŒç•°ãªã£ã¦ã„ãŸ
- **é–¢å¿ƒã®åˆ†é›¢å®Ÿç¾**: ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¨ã‚·ã‚¹ãƒ†ãƒ ãŒåŒä¸€ãƒ•ã‚¡ã‚¤ãƒ«ã«æ··åœ¨ â†’ é©åˆ‡ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«åˆ†é›¢
- **å‘½åè¡çªã®è§£æ±º**: `upgradeable_stat::Level` ã¨ `management_stats::Level` ã®é‡è¤‡ â†’ `UpgradeLevel` ã«å¤‰æ›´
- **ECSåŸå‰‡ã¸ã®æº–æ‹ **: ä»–ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¨åŒã˜æ§‹æˆãƒ‘ã‚¿ãƒ¼ãƒ³ã«çµ±ä¸€

### 7.2 å®Ÿè£…ã—ãŸã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

**ç§»è¡Œå‰ã®æ§‹é€ **:
```rust
// Before: æ ¹ãƒ¬ãƒ™ãƒ«ã«å…¨ã¦æ··åœ¨
src/upgradeable_stat.rs  // ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ + ã‚·ã‚¹ãƒ†ãƒ  + ãƒ†ã‚¹ãƒˆ (371è¡Œ)
```

**ç§»è¡Œå¾Œã®æ§‹é€ **:
```rust
// After: é–¢å¿ƒã®åˆ†é›¢å®Œäº†
src/components/upgradeable_stats.rs  // ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå®šç¾©ãƒ»Bundleãƒ»ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
src/systems/upgrades.rs              // ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ãƒ»åŒæœŸã‚·ã‚¹ãƒ†ãƒ 
```

**ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®æ•´ç†** (`components/upgradeable_stats.rs`):
```rust
// åŸºæœ¬ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
CurrentValue, BaseValue, UpgradeLevel  // Level â†’ UpgradeLevel ã«å¤‰æ›´
UpgradeCost, UpgradeMultiplier, CostMultiplier

// å‹å®‰å…¨ãƒãƒ¼ã‚«ãƒ¼
UpgradeableHp, UpgradeableAttack, UpgradeableDefense, UpgradeableSpeed

// Bundleæ§‹æˆ
UpgradeableStatBundle, UpgradeableHpBundle, UpgradeableAttackBundle, ...
```

**ã‚·ã‚¹ãƒ†ãƒ ã®æ•´ç†** (`systems/upgrades.rs`):
```rust
// ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã‚·ã‚¹ãƒ†ãƒ 
upgradeable_stat_upgrade_system()     // çµŒé¨“å€¤ã«ã‚ˆã‚‹è‡ªå‹•ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰
update_current_value_on_change()      // å€¤å¤‰æ›´æ™‚ã®å†è¨ˆç®—

// åŒæœŸã‚·ã‚¹ãƒ†ãƒ ï¼ˆcombat_end.rs ã‹ã‚‰ç§»å‹•ï¼‰
hp_sync_system(), attack_sync_system()  // å„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å°‚ç”¨åŒæœŸ
defense_sync_system(), speed_sync_system()
```

### 7.3 çµæœã¨æ¤œè¨¼
- **ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æˆåŠŸ**: ãƒ‡ãƒãƒƒã‚°ãƒ»ãƒªãƒªãƒ¼ã‚¹ãƒ“ãƒ«ãƒ‰å…±ã«æˆåŠŸ
- **å…¨ãƒ†ã‚¹ãƒˆé€šé**: 24å€‹ã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã™ã¹ã¦æˆåŠŸ
- **æ©Ÿèƒ½ãƒªã‚°ãƒ¬ãƒƒã‚·ãƒ§ãƒ³ãªã—**: ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ãƒ»åŒæœŸã‚·ã‚¹ãƒ†ãƒ ãŒæ­£å¸¸å‹•ä½œ
- **ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£çµ±ä¸€**: ä»–ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¨åŒã˜æ§‹æˆãƒ‘ã‚¿ãƒ¼ãƒ³ã«æº–æ‹ 
- **å‘½åè¡çªè§£æ¶ˆ**: `management_stats::Level` ã¨ `UpgradeLevel` ã§æ˜ç¢ºã«åˆ†é›¢

### 7.4 æŠ€è¡“çš„è©³ç´°
- **ãƒ•ã‚¡ã‚¤ãƒ«åˆ†é›¢**: 371è¡Œã®å·¨å¤§ãƒ•ã‚¡ã‚¤ãƒ« â†’ é©åˆ‡ãªé–¢å¿ƒäº‹ã”ã¨ã«åˆ†é›¢
- **å‘½åå¤‰æ›´**: `upgradeable_stat::Level` â†’ `upgradeable_stats::UpgradeLevel`
- **ã‚·ã‚¹ãƒ†ãƒ ç§»å‹•**: åŒæœŸã‚·ã‚¹ãƒ†ãƒ ã‚’ `combat_end.rs` ã‹ã‚‰ `upgrades.rs` ã«é›†ç´„
- **ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ•´ç†**: å¤ã„ `crate::upgradeable_stat::` å‚ç…§ã‚’ã™ã¹ã¦æ›´æ–°
- **å¾Œæ–¹äº’æ›æ€§**: æ—¢å­˜ã®APIã‚’ç¶­æŒã—ã¤ã¤æ§‹é€ ã‚’æ”¹å–„

## 8. ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•æˆ¦é—˜é–‹å§‹ã‚·ã‚¹ãƒ†ãƒ å®Ÿè£… (2025-06-20)

### 8.1 è§£æ±ºã—ãŸå•é¡Œ
- **ç›´æ¥çš„çŠ¶æ…‹å¤‰æ›´ã®æ’é™¤**: UIã‚·ã‚¹ãƒ†ãƒ ãŒ`CombatState`ã‚’ç›´æ¥å¤‰æ›´ã—ã¦ã„ãŸå•é¡Œã‚’è§£æ±º
- **æˆ¦é—˜é–‹å§‹ãƒ•ãƒ­ãƒ¼ã®çµ±ä¸€**: ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã€æ‰‹å‹•ãƒªãƒˆãƒ©ã‚¤ã€ã‚ªãƒ¼ãƒˆãƒªãƒˆãƒ©ã‚¤ãŒç•°ãªã‚‹ãƒ­ã‚¸ãƒƒã‚¯ã‚’ä½¿ç”¨ã—ã¦ã„ãŸå•é¡Œ
- **ã‚ªãƒ¼ãƒˆãƒªãƒˆãƒ©ã‚¤ã®å³å¿œæ€§**: ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼çŠ¶æ…‹ã§ã‚ªãƒ¼ãƒˆãƒªãƒˆãƒ©ã‚¤ã‚’ONã«ã—ã¦ã‚‚æˆ¦é—˜ãŒå§‹ã¾ã‚‰ãªã„å•é¡Œ
- **è²¬ä»»ã®åˆ†é›¢**: UIãƒ»æ­»äº¡ã‚·ã‚¹ãƒ†ãƒ ãƒ»æˆ¦é—˜ã‚·ã‚¹ãƒ†ãƒ é–“ã®ç–çµåˆã‚’å®Ÿç¾

### 8.2 å®Ÿè£…ã—ãŸã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

**æ–°ã—ã„ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•ãƒ•ãƒ­ãƒ¼**:
```rust
// æˆ¦é—˜é–‹å§‹ã®çµ±ä¸€ã‚¤ãƒ™ãƒ³ãƒˆ
#[derive(Event)]
pub struct CombatStartEvent {
    pub is_retry: bool,
}

// æˆ¦é—˜é–‹å§‹ã‚·ã‚¹ãƒ†ãƒ ï¼ˆä¸€å…ƒç®¡ç†ï¼‰
combat_start_system() â†’ combat_state.in_dungeon = true
```

**ã‚¤ãƒ™ãƒ³ãƒˆç™ºè¡Œæº**:
```rust
// 1. ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³ãƒœã‚¿ãƒ³ï¼ˆæ–°è¦ãƒ»æ‰‹å‹•ãƒªãƒˆãƒ©ã‚¤ï¼‰
dungeon_button_system() â†’ CombatStartEvent { is_retry: false/true }

// 2. ã‚ªãƒ¼ãƒˆãƒªãƒˆãƒ©ã‚¤ãƒœã‚¿ãƒ³ï¼ˆã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ä¸­ã®åˆ‡ã‚Šæ›¿ãˆï¼‰
auto_retry_button_system() â†’ CombatStartEvent { is_retry: true }

// 3. æ­»äº¡æ™‚ã‚ªãƒ¼ãƒˆãƒªãƒˆãƒ©ã‚¤
player_death_system() â†’ CombatStartEvent { is_retry: true }
```

**æˆ¦é—˜åˆæœŸåŒ–ãƒ•ãƒ­ãƒ¼**:
```rust
CombatStartEvent â†’ combat_start_system â†’ combat_init_system â†’ æˆ¦é—˜ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè¿½åŠ 
```

### 8.3 çµæœã¨æ¤œè¨¼
- **å®Œå…¨ãªã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•**: å…¨ã¦ã®æˆ¦é—˜é–‹å§‹ãŒ`CombatStartEvent`ã§çµ±ä¸€
- **å³å¿œã‚ªãƒ¼ãƒˆãƒªãƒˆãƒ©ã‚¤**: ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ä¸­ã®ãƒœã‚¿ãƒ³æ“ä½œã§å³åº§ã«æˆ¦é—˜é–‹å§‹
- **è²¬ä»»åˆ†é›¢**: UIã¯çŠ¶æ…‹å¤‰æ›´ã›ãšã€ã‚¤ãƒ™ãƒ³ãƒˆç™ºè¡Œã®ã¿ã«è²¬ä»»ã‚’é™å®š
- **ä¸€è²«ã—ãŸåˆæœŸåŒ–**: `combat_init_system`ãŒç¢ºå®Ÿã«å®Ÿè¡Œã•ã‚Œã€æˆ¦é—˜ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒè¿½åŠ 
- **å…¨ãƒ†ã‚¹ãƒˆé€šé**: 27å€‹ã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã§æ—¢å­˜æ©Ÿèƒ½ã¸ã®å½±éŸ¿ãªã—ã‚’ç¢ºèª

### 8.4 æŠ€è¡“çš„è©³ç´°
- **æ–°ãƒ•ã‚¡ã‚¤ãƒ«**: `src/systems/combat_start.rs` - æˆ¦é—˜é–‹å§‹ã®ä¸€å…ƒç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 
- **ã‚¤ãƒ™ãƒ³ãƒˆè¿½åŠ **: `src/events/combat_events.rs` - `CombatStartEvent`å®šç¾©
- **UIä¿®æ­£**: `src/ui/dungeon_ui.rs` - ã‚¤ãƒ™ãƒ³ãƒˆç™ºè¡Œã¸ã®å¤‰æ›´
- **æ­»äº¡ã‚·ã‚¹ãƒ†ãƒ ä¿®æ­£**: `src/systems/combat_end.rs` - ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•ã‚ªãƒ¼ãƒˆãƒªãƒˆãƒ©ã‚¤
- **ãƒ—ãƒ©ã‚°ã‚¤ãƒ³æ›´æ–°**: `src/plugins/combat.rs` - æ–°ã‚·ã‚¹ãƒ†ãƒ ãƒ»ã‚¤ãƒ™ãƒ³ãƒˆã®ç™»éŒ²

ã“ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã€ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ã®æˆé•·ã¨å…±ã«å®šæœŸçš„ã«æ›´æ–°ã—ã€ECSè¨­è¨ˆåŸå‰‡ã¨ã®æ•´åˆæ€§ã‚’ç¶­æŒã™ã‚‹ã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™ã€‚